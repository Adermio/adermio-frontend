<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votre Analyse Cutanée — Adermio</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<style>
  html, body { margin:0 !important; padding:0 !important; background:#f8fafc; }

  #free-loading, #free-error{
    position:fixed; inset:0; z-index:999999;
    display:flex; align-items:center; justify-content:center;
    font-family: Arial, sans-serif; padding:24px; text-align:center;
    background:#f8fafc;
  }
  #free-error{ display:none; }

  .free-box{
    width:100%; max-width:520px;
    background:#ffffff;
    border:1px solid #e2e8f0;
    border-radius:16px;
    padding:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.06);
  }
  .free-title{
    font-weight:700; font-size:18px; color:#0f172a;
    margin:0 0 8px 0;
  }
  .free-text{
    font-size:14px; line-height:1.5; color:#475569;
    margin:0;
  }
  .free-sub{
    margin-top:10px;
    font-size:12px; color:#64748b;
  }

  .spinner{
    width:18px; height:18px; border-radius:999px;
    border:2px solid #cbd5e1; border-top-color:#0ea5e9;
    display:inline-block; vertical-align:-3px; margin-right:10px;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .progress-wrap{
    margin-top:14px;
    width:100%; height:8px; background:#eef2ff;
    border-radius:999px; overflow:hidden;
    border:1px solid #e2e8f0;
  }
  .progress-bar{
    height:100%; width:0%;
    background:#0ea5e9;
    transition: width 0.25s linear;
  }

  .btn{
    display:inline-block;
    margin-top:14px;
    padding:10px 14px;
    border-radius:12px;
    border:1px solid #e2e8f0;
    background:#fff;
    color:#0f172a;
    font-size:14px;
    cursor:pointer;
  }
  .btn:hover{ background:#f8fafc; }

  .err{
    color:#b00020;
    font-weight:700;
    margin:0 0 8px 0;
  }
</style>

<div id="free-loading">
  <div class="free-box">
    <div class="free-title"><span class="spinner"></span>Chargement de votre analyse…</div>
    <p class="free-text" id="free-status-text">Finalisation du rapport en cours.</p>
    <div class="progress-wrap" aria-hidden="true">
      <div class="progress-bar" id="free-progress"></div>
    </div>
    <div class="free-sub" id="free-subtext">Merci de patienter, cela peut prendre quelques secondes.</div>
  </div>
</div>

<div id="free-error">
  <div class="free-box">
    <p class="err" id="free-error-title">Erreur</p>
    <p class="free-text" id="free-error-msg"></p>
    <button class="btn" id="free-retry-btn" style="display:none;">Réessayer</button>
  </div>
</div>

<script>
(async function () {
  const loadingEl = document.getElementById("free-loading");
  const statusTextEl = document.getElementById("free-status-text");
  const subTextEl = document.getElementById("free-subtext");
  const progressEl = document.getElementById("free-progress");

  const errorWrapEl = document.getElementById("free-error");
  const errorTitleEl = document.getElementById("free-error-title");
  const errorMsgEl = document.getElementById("free-error-msg");
  const retryBtn = document.getElementById("free-retry-btn");

  const params = new URLSearchParams(window.location.search);
  const token = (params.get("token") || "").trim();
  
  // --- NOUVEAU: Detection du mode force ---
  // On regarde si l'URL contient &force=true
  const isForced = params.get("force") === "true";

  const ENDPOINT = "https://ai.adermio.com/api/get_free_analysis_html";
  const MAX_WAIT_MS = 60000;      // 60s max
  const MIN_HTML_LEN = 50;

  function getIntervalMs(elapsedMs) {
    if (elapsedMs < 8000) return 800;
    if (elapsedMs < 25000) return 1200;
    return 2000;
  }

  let aborted = false;

  function showError(title, msg, canRetry) {
    if (loadingEl) loadingEl.style.display = "none";
    if (errorWrapEl) errorWrapEl.style.display = "flex";

    if (errorTitleEl) errorTitleEl.textContent = title || "Erreur";
    if (errorMsgEl) errorMsgEl.textContent = msg || "Une erreur est survenue.";

    if (retryBtn) retryBtn.style.display = canRetry ? "inline-block" : "none";
  }

  function setLoadingText(main, sub) {
    if (statusTextEl && typeof main === "string") statusTextEl.textContent = main;
    if (subTextEl && typeof sub === "string") subTextEl.textContent = sub;
  }

  function setProgress(pct) {
    if (!progressEl) return;
    const v = Math.max(0, Math.min(100, pct));
    progressEl.style.width = v.toFixed(0) + "%";
  }

  async function safeJson(resp) {
    try { return await resp.json(); } catch { return null; }
  }

  async function sleep(ms) {
    return new Promise(res => setTimeout(res, ms));
  }

  async function fetchOnce(token) {
    // --- NOUVEAU: Construction du payload intelligent ---
    const payload = { token };
    
    // Si l'URL contient force=true, on l'ajoute au body de la requête
    if (isForced) {
        payload.force = true;
        payload.confirm = true;
    }

    const resp = await fetch(ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      cache: "no-store",
    });
    const data = await safeJson(resp);
    return { resp, data };
  }

  async function fetchWithRetry(token) {
    const t0 = Date.now();

    while (!aborted && (Date.now() - t0) < MAX_WAIT_MS) {
      const elapsed = Date.now() - t0;
      const intervalMs = getIntervalMs(elapsed);

      // Progress "ressenti"
      const pct = Math.min(95, (elapsed / MAX_WAIT_MS) * 100);
      setProgress(pct);

      try {
        const { resp, data } = await fetchOnce(token);

        if (resp.ok) {
          const html = (data && typeof data.html === "string") ? data.html : "";
          if (html && html.length >= MIN_HTML_LEN) return html;

          setLoadingText("Finalisation du rapport…", "Encore quelques secondes.");
          await sleep(intervalMs);
          continue;
        }

        // 409 = not ready / finalizing => on repoll
        // (Si isForced est true, le serveur ne devrait PLUS renvoyer 409 pour le cas RETRY_NEEDED)
        if (resp.status === 409) {
          setLoadingText("Finalisation du rapport…", "Nous préparons l’affichage de votre analyse.");
          await sleep(intervalMs);
          continue;
        }

        // 410 = expired => stop
        if (resp.status === 410) throw new Error("expired");

        // 401/400 = token invalide => stop
        if (resp.status === 400 || resp.status === 401) throw new Error("invalid");

        // autres erreurs => stop
        const msg = (data && data.error) ? String(data.error) : ("HTTP " + resp.status);
        throw new Error("server:" + msg);

      } catch (e) {
        setLoadingText("Connexion…", "Petite difficulté réseau, nouvelle tentative…");
        await sleep(Math.min(2500, getIntervalMs(Date.now() - t0)));
      }
    }

    throw new Error("timeout");
  }

  // ---- RUN ----
  if (!token) {
    showError("Lien invalide", "Token manquant dans l’URL.", false);
    return;
  }

  if (retryBtn) retryBtn.addEventListener("click", () => window.location.reload());
  window.addEventListener("beforeunload", () => { aborted = true; });

  setProgress(5);
  setLoadingText("Chargement de votre analyse…", "Merci de patienter.");

  try {
    const html = await fetchWithRetry(token);

    // 100% + injection
    setProgress(100);

    document.open();
    document.write(html);
    document.close();

  } catch (e) {
    const code = String(e && e.message ? e.message : e);

    if (code === "expired") {
      showError(
        "Analyse expirée",
        "⏳ Cette analyse a expiré. Veuillez relancer une analyse.",
        false
      );
      return;
    }

    if (code === "invalid") {
      showError(
        "Lien invalide",
        "Ce lien ne semble pas valide. Vérifiez qu’il est complet, puis réessayez.",
        false
      );
      return;
    }

    if (code === "timeout") {
      showError(
        "Ça prend plus de temps que prévu",
        "Votre analyse est en cours de finalisation. Réessayez dans quelques secondes.",
        true
      );
      return;
    }

    // Erreur serveur / autre
    showError(
      "Erreur de chargement",
      "Une erreur est survenue. Réessayez dans quelques secondes.",
      true
    );
    console.error("[free-analysis] error:", e);
  }
})();
</script>
</body>
</html>
