<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adermio - Expert Diagnosis</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0F3D39',
                            primary: '#14B8A6',
                            light: '#F0FDFA',
                            cream: '#FAFAF9',
                            sand: '#E7E5E4',
                            gold: '#D4B483'
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"DM Sans"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'scan': 'scan 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: '0.6' },
                            '50%': { opacity: '1' },
                        },
                        scan: {
                            '0%, 100%': { top: '0%' },
                            '50%': { top: '100%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .step-container {
            transition: opacity 0.3s ease;
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            pointer-events: none;
            display: none;
        }

        .step-container.active {
            opacity: 1;
            pointer-events: all;
            display: block;
            position: relative;
            margin-top: auto;
            margin-bottom: auto;
        }

        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #0F3D39;
            border: 2px solid white;
            cursor: pointer;
            margin-top: -9px;
            box-shadow: 0 2px 6px rgba(15, 61, 57, 0.2);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: #E7E5E4;
        }

        .sketch-line {
            fill: none;
            stroke: #44403C;
            stroke-width: 1.2;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.8;
        }

        .zone-spot {
            fill: transparent;
            cursor: pointer;
            transition: all 0.4s ease-out;
        }

        @media (hover: hover) {
            .zone-spot:hover {
                fill: rgba(20, 184, 166, 0.1);
            }
        }

        .zone-spot.selected {
            fill: rgba(20, 184, 166, 0.4);
            filter: blur(4px);
        }

        .zone-item {
            transition: all 0.2s;
        }
        .zone-item.selected {
            background-color: #F0FDFA;
            border-color: #14B8A6;
            color: #0F3D39;
            font-weight: 500;
        }
        .zone-item.selected .indicator {
            background-color: #14B8A6;
            border-color: #14B8A6;
        }

        textarea {
            resize: none;
        }

        .input-error {
            border-color: #ef4444 !important;
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        #loading-overlay {
            backdrop-filter: blur(5px);
        }

        #age-inline-input {
            width: 4.5rem;
            text-align: right;
            background: transparent;
            border: none;
            outline: none;
        }

        .lang-dropdown {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s ease;
        }
        .group:hover .lang-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-brand-cream text-brand-dark font-sans min-h-screen flex flex-col selection:bg-brand-primary/20">

    <div id="loading-overlay" class="fixed inset-0 z-[120] bg-brand-cream/80 hidden items-center justify-center flex-col">
        <div class="w-12 h-12 border-4 border-brand-primary/30 border-t-brand-primary rounded-full animate-spin mb-4"></div>
        <p class="font-serif text-brand-dark animate-pulse">Sending your data...</p>
    </div>

    <header class="fixed top-0 w-full z-50 bg-brand-cream/90 backdrop-blur-xl border-b border-stone-200/50">
        <div class="max-w-xl mx-auto px-6 py-5 flex items-center justify-between">
            <div class="flex items-center gap-3">
                 <div class="w-2 h-2 rounded-full bg-brand-dark"></div>
                <span class="font-serif text-lg tracking-wide text-brand-dark">Adermio</span>
            </div>

            <div class="flex items-center gap-4">
                <div class="relative group">
                    <button class="flex items-center gap-1.5 px-2 py-1 rounded-full hover:bg-black/5 transition-colors text-brand-dark">
                        <img src="https://flagcdn.com/us.svg" width="16" alt="EN" class="rounded-sm shadow-sm">
                        <i data-lucide="chevron-down" class="w-3 h-3 opacity-50"></i>
                    </button>
                    <div class="lang-dropdown absolute right-0 top-full mt-2 w-32 bg-white rounded-xl shadow-lg border border-brand-dark/5 overflow-hidden z-[80]">
                        <a href="#" class="flex items-center gap-3 px-4 py-3 text-sm font-medium bg-teal-50/50 text-teal-700">
                            <img src="https://flagcdn.com/us.svg" width="18" alt="English" class="rounded-sm shadow-sm">
                            <span>EN</span>
                        </a>
                        <a href="https://adermio.com/formulaire" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-brand-dark hover:bg-gray-50 transition-colors">
                            <img src="https://flagcdn.com/fr.svg" width="18" alt="Fran&ccedil;ais" class="rounded-sm shadow-sm">
                            <span>FR</span>
                        </a>
                    </div>
                </div>

                <div class="flex gap-1.5" id="progress-container"></div>
            </div>
        </div>
    </header>

<main class="flex-grow flex flex-col px-6 pt-28 pb-64 max-w-2xl mx-auto w-full relative min-h-[90vh]">

        <div id="step-1" class="step-container active">
            <div class="space-y-8 animate-fade-in max-w-xl mx-auto">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white border border-stone-200 text-[10px] uppercase tracking-widest text-stone-500 shadow-sm">
                    <span class="w-1.5 h-1.5 rounded-full bg-brand-primary animate-pulse"></span>
                    AI Diagnosis
                </div>

                <h1 class="font-serif text-5xl leading-[1.15] text-brand-dark">
                    Your skin has <br><span class="text-brand-primary italic">a story.</span>
                </h1>

                <p class="text-stone-500 text-lg font-light leading-relaxed max-w-sm">
                    Let our technology analyze your unique needs to create your bespoke protocol.
                </p>

                <div class="pt-8 relative group" id="name-input-container">
                    <input type="text" id="input-name" placeholder="Your first name" class="w-full text-3xl bg-transparent border-b border-stone-300 focus:border-brand-dark focus:outline-none py-4 placeholder-stone-300 text-brand-dark transition-all font-serif">
                    <p id="error-message" class="text-red-500 text-xs mt-3 hidden flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> First name required</p>
                </div>
            </div>
        </div>

        <div id="step-2" class="step-container">
            <div class="space-y-10 animate-fade-in max-w-xl mx-auto">
                <div>
                    <h2 class="font-serif text-3xl mb-3 text-brand-dark">Hello, <span class="user-name-display capitalize text-brand-primary">...</span></h2>
                    <p class="text-stone-500 font-light">This information allows us to calibrate the diagnosis.</p>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <label class="cursor-pointer group">
                        <input type="radio" name="gender" value="femme" class="peer hidden" checked>
                        <div class="h-14 rounded-2xl border border-stone-200 bg-white flex items-center justify-center text-stone-400 peer-checked:border-brand-dark peer-checked:text-brand-dark peer-checked:bg-stone-50 transition-all hover:border-brand-dark/30">
                            <span class="font-serif text-base">Female</span>
                        </div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="radio" name="gender" value="homme" class="peer hidden">
                        <div class="h-14 rounded-2xl border border-stone-200 bg-white flex items-center justify-center text-stone-400 peer-checked:border-brand-dark peer-checked:text-brand-dark peer-checked:bg-stone-50 transition-all hover:border-brand-dark/30">
                            <span class="font-serif text-base">Male</span>
                        </div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="radio" name="gender" value="autre" class="peer hidden">
                        <div class="h-14 rounded-2xl border border-stone-200 bg-white flex items-center justify-center text-stone-400 peer-checked:border-brand-dark peer-checked:text-brand-dark peer-checked:bg-stone-50 transition-all hover:border-brand-dark/30">
                            <span class="font-serif text-base">Other</span>
                        </div>
                    </label>
                </div>

                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-stone-100">
                    <div class="flex justify-between items-end mb-6">
                        <label class="text-xs font-bold text-stone-400 uppercase tracking-widest">Your age</label>
                        <div class="flex items-baseline gap-1">
                            <input
                                id="age-inline-input"
                                type="number"
                                inputmode="numeric"
                                min="12"
                                max="65"
                                value="24"
                                class="text-4xl font-serif text-brand-dark"
                                aria-label="Age"
                            />
                            <span class="text-sm text-stone-400 font-serif">years</span>
                        </div>
                    </div>
                    <div class="relative h-6 flex items-center">
                        <input type="range" min="12" max="65" value="24" class="w-full z-10" id="age-slider">
                        <div class="absolute w-full flex justify-between px-1 pointer-events-none opacity-30">
                            <div class="w-0.5 h-2 bg-stone-400"></div>
                            <div class="w-0.5 h-2 bg-stone-400"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="step-3" class="step-container">
            <div class="text-center mb-8">
                <span class="text-[10px] font-bold uppercase tracking-widest text-brand-primary mb-2 block animate-pulse">Adermio Scan&trade; Technology</span>
                <h2 class="font-serif text-3xl text-brand-dark">High Definition Analysis</h2>
            </div>

            <div class="bg-brand-light/50 border border-brand-primary/20 rounded-xl p-4 mb-6 max-w-sm mx-auto">
                <h4 class="text-xs font-bold uppercase text-brand-dark mb-2 flex items-center gap-2">
                    <i data-lucide="info" class="w-3 h-3"></i> Tips for a perfect analysis
                </h4>
                <ul class="text-xs text-stone-600 space-y-1 font-light">
                    <li>&bull; Face well-centered and well-lit.</li>
                    <li>&bull; Hair pulled back, no glasses.</li>
                    <li>&bull; Skin without makeup if possible.</li>
                </ul>
            </div>

            <div class="space-y-4 animate-fade-in max-w-sm mx-auto">

                <div class="relative w-10/12 mx-auto sm:w-full">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <label class="text-xs font-bold uppercase text-brand-dark tracking-wide">1. Face (Front)</label>
                        <span class="text-[10px] font-bold text-white bg-brand-primary px-2 py-0.5 rounded-full">Required</span>
                    </div>

                    <label class="block relative group cursor-pointer w-full aspect-square sm:aspect-[4/5] rounded-[1.5rem] sm:rounded-[2rem] overflow-hidden shadow-xl sm:shadow-2xl transition-all duration-500 hover:shadow-[0_20px_60px_-15px_rgba(20,184,166,0.3)]">
                        <input type="file" accept="image/*,.heic,.heif,.heics,.avif,.webp,.bmp,.tif,.tiff,.dng,.cr2,.nef,.arw,.raw" class="absolute inset-0 w-full h-full opacity-0 z-50 cursor-pointer"
                               data-type="face"
                               onclick="event.stopPropagation()"
                               onchange="handleImageUpload(this, 'preview-face', 'overlay-face', 'empty-face')">

                        <div class="absolute inset-0 bg-stone-900 z-0 pointer-events-none">
                            <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-stone-800 to-stone-950"></div>
                        </div>

                        <div id="empty-face" class="relative z-10 h-full flex flex-col items-center justify-center p-6 text-center transition-opacity duration-300 pointer-events-none">
                            <div class="w-24 h-24 sm:w-28 sm:h-28 rounded-full border border-white/10 flex items-center justify-center mb-3 sm:mb-4 group-hover:scale-105 group-hover:border-brand-primary transition-all duration-500 backdrop-blur-sm bg-white/5">
                                <svg viewBox="0 0 100 120" class="w-16 h-16 sm:w-20 sm:h-20 stroke-white/40 fill-none stroke-[1.5]" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20,40 Q20,10 50,10 T80,40 V60 Q80,95 50,105 Q20,95 20,60 Z" />
                                    <path d="M30,50 Q35,45 40,50" />
                                    <path d="M60,50 Q65,45 70,50" />
                                    <path d="M48,60 L50,70 L52,60" />
                                    <path d="M40,85 Q50,90 60,85" />
                                </svg>
                            </div>
                            <span class="text-white text-base sm:text-lg font-serif mb-1">Front photo</span>
                            <span class="text-white/40 text-[10px] sm:text-xs font-light">Tap to add</span>
                        </div>

                        <img id="preview-face" class="absolute inset-0 w-full h-full object-cover hidden z-20 pointer-events-none">
                        <div id="overlay-face" class="absolute inset-0 z-30 bg-black/40 hidden flex-col items-center justify-center backdrop-blur-[2px] pointer-events-none">
                            <div class="absolute top-0 left-0 w-full h-[2px] bg-brand-primary shadow-[0_0_20px_rgba(20,184,166,1)] animate-scan"></div>
                            <div class="absolute bottom-8 px-3 py-1 rounded-full border border-brand-primary/50 bg-black/50 text-brand-primary text-[10px] uppercase tracking-widest animate-pulse">Analyzing...</div>
                        </div>
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-2">
                    <div class="relative">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <label class="text-[10px] font-bold uppercase text-brand-dark tracking-wide">Left Profile</label>
                            <span class="text-[8px] uppercase tracking-widest font-bold text-stone-400 border border-stone-200 px-1.5 py-0.5 rounded">Optional</span>
                        </div>
                        <label class="block relative group cursor-pointer w-full aspect-square rounded-[1.5rem] overflow-hidden bg-stone-900 shadow-lg">
                            <input type="file" accept="image/*,.heic,.heif,.heics,.avif,.webp,.bmp,.tif,.tiff,.dng,.cr2,.nef,.arw,.raw" class="absolute inset-0 w-full h-full opacity-0 z-50 cursor-pointer"
                                   data-type="left"
                                   onclick="event.stopPropagation()"
                                   onchange="handleImageUpload(this, 'preview-left', 'overlay-left', 'empty-left')">

                            <div id="empty-left" class="absolute inset-0 flex flex-col items-center justify-center text-center opacity-70 group-hover:opacity-100 transition-opacity pointer-events-none">
                                <svg viewBox="0 0 100 100" class="w-16 h-16 stroke-white/40 fill-none stroke-[1.2] mb-1 transform -scale-x-100">
                                    <path d="M45,90 C35,80 30,60 30,45 C30,25 45,15 60,15 C75,15 80,30 80,45 L85,50 L80,55 C80,65 80,80 70,90" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M80,45 L85,50 L80,55" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span class="text-[10px] text-white/40 uppercase tracking-widest">Add</span>
                            </div>
                            <img id="preview-left" class="absolute inset-0 w-full h-full object-cover hidden z-20 pointer-events-none">
                            <div id="overlay-left" class="absolute inset-0 z-30 bg-black/40 hidden flex-col items-center justify-center backdrop-blur-[1px] pointer-events-none">
                                <div class="absolute top-0 left-0 w-full h-[1px] bg-brand-primary shadow-[0_0_15px_rgba(20,184,166,1)] animate-scan"></div>
                            </div>
                        </label>
                    </div>

                    <div class="relative">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <label class="text-[10px] font-bold uppercase text-brand-dark tracking-wide">Right Profile</label>
                            <span class="text-[8px] uppercase tracking-widest font-bold text-stone-400 border border-stone-200 px-1.5 py-0.5 rounded">Optional</span>
                        </div>
                        <label class="block relative group cursor-pointer w-full aspect-square rounded-[1.5rem] overflow-hidden bg-stone-900 shadow-lg">
                            <input type="file" accept="image/*,.heic,.heif,.heics,.avif,.webp,.bmp,.tif,.tiff,.dng,.cr2,.nef,.arw,.raw" class="absolute inset-0 w-full h-full opacity-0 z-50 cursor-pointer"
                                   data-type="right"
                                   onclick="event.stopPropagation()"
                                   onchange="handleImageUpload(this, 'preview-right', 'overlay-right', 'empty-right')">

                            <div id="empty-right" class="absolute inset-0 flex flex-col items-center justify-center text-center opacity-70 group-hover:opacity-100 transition-opacity pointer-events-none">
                                <svg viewBox="0 0 100 100" class="w-16 h-16 stroke-white/40 fill-none stroke-[1.2] mb-1">
                                    <path d="M45,90 C35,80 30,60 30,45 C30,25 45,15 60,15 C75,15 80,30 80,45 L85,50 L80,55 C80,65 80,80 70,90" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M80,45 L85,50 L80,55" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span class="text-[10px] text-white/40 uppercase tracking-widest">Add</span>
                            </div>
                            <img id="preview-right" class="absolute inset-0 w-full h-full object-cover hidden z-20 pointer-events-none">
                            <div id="overlay-right" class="absolute inset-0 z-30 bg-black/40 hidden flex-col items-center justify-center backdrop-blur-[1px] pointer-events-none">
                                <div class="absolute top-0 left-0 w-full h-[1px] bg-brand-primary shadow-[0_0_15px_rgba(20,184,166,1)] animate-scan"></div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="button" id="toggle-zoom-btn" class="w-full py-3 rounded-2xl border border-dashed border-stone-300 text-stone-400 text-xs font-bold flex items-center justify-center gap-2 hover:border-brand-primary hover:text-brand-primary transition-all uppercase tracking-wide" onclick="toggleZoomArea()">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Add zoom area (Optional)
                    </button>

                    <div id="zoom-area" class="hidden mt-4 animate-fade-in">
                        <label class="block relative group cursor-pointer w-full h-32 rounded-[1.5rem] overflow-hidden bg-stone-900 shadow-lg">
                            <input type="file" accept="image/*,.heic,.heif,.heics,.avif,.webp,.bmp,.tif,.tiff,.dng,.cr2,.nef,.arw,.raw" class="absolute inset-0 w-full h-full opacity-0 z-50 cursor-pointer"
                                   data-type="zoom"
                                   onclick="event.stopPropagation()"
                                   onchange="handleImageUpload(this, 'preview-zoom', 'overlay-zoom', 'empty-zoom')">

                            <div id="empty-zoom" class="absolute inset-0 flex items-center justify-center gap-3 text-white/60 pointer-events-none">
                                <i data-lucide="zoom-in" class="w-5 h-5"></i>
                                <span class="text-xs font-medium">Detail photo</span>
                            </div>

                            <img id="preview-zoom" class="absolute inset-0 w-full h-full object-cover hidden z-20 pointer-events-none">

                            <div id="overlay-zoom" class="absolute inset-0 z-30 bg-black/40 hidden flex-col items-center justify-center backdrop-blur-[1px] pointer-events-none">
                                <div class="absolute top-0 left-0 w-full h-[1px] bg-brand-primary shadow-[0_0_15px_rgba(20,184,166,1)] animate-scan"></div>
                            </div>
                        </label>
                    </div>
                </div>

            </div>

            <p id="photo-error" class="text-red-500 text-xs text-center mt-6 hidden flex items-center justify-center gap-1 animate-pulse">
                <i data-lucide="alert-circle" class="w-3 h-3"></i> Front photo is required.
            </p>
            <p id="file-type-error" class="text-red-500 text-xs text-center mt-2 hidden flex items-center justify-center gap-1 animate-pulse">
                <i data-lucide="alert-circle" class="w-3 h-3"></i> This file format is not supported.
            </p>
        </div>

        <div id="step-4" class="step-container">
            <div class="space-y-8 animate-fade-in max-w-xl mx-auto">
                <div>
                    <h2 class="font-serif text-3xl mb-3 text-brand-dark">Your skin profile</h2>
                    <p class="text-stone-500 font-light">To adapt the protocol to your situation.</p>
                </div>

                <div class="mb-6">
                    <label class="text-xs font-bold uppercase text-stone-400 tracking-widest block mb-3">Today, your goal is mainly to...</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="goal-selection">
                        <button type="button" onclick="setGoal('correction')" class="zone-item selected w-full p-4 rounded-xl border border-stone-200 bg-white text-left group transition-all" id="btn-goal-correction">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-3 h-3 rounded-full bg-red-400"></div>
                                <span class="font-bold text-sm text-brand-dark">Correct</span>
                            </div>
                            <span class="block text-xs font-medium text-brand-dark/90 italic leading-snug mb-3">
                                "I have acne (regular or persistent) and I want to clear it."
                            </span>
                            <span class="text-xs text-stone-500 block leading-tight">
                                Reduce spots, marks and inflammation
                            </span>
                        </button>

                        <button type="button" onclick="setGoal('stabilisation')" class="zone-item w-full p-4 rounded-xl border border-stone-200 bg-white text-left group transition-all" id="btn-goal-stabilisation">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-3 h-3 rounded-full bg-green-400"></div>
                                <span class="font-bold text-sm text-brand-dark">Maintain/Stabilize</span>
                            </div>
                            <span class="block text-xs font-medium text-brand-dark/90 italic leading-snug mb-3">
                                "My skin is generally okay, but I get occasional blemishes."
                            </span>
                            <span class="text-xs text-stone-500 block leading-tight">
                                Avoid recurrences, smooth texture, keep skin clear
                            </span>
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-stone-100 transition-all duration-300" id="history-card">

                    <div id="duration-container">
                        <div class="flex flex-col mb-6 gap-2">
                            <label class="text-xs font-bold text-stone-400 uppercase tracking-widest leading-relaxed">How long have you been observing regular breakouts?</label>
                            <span class="text-2xl font-serif text-brand-dark" id="duration-display">3-6 months</span>
                        </div>
                        <div class="relative h-6 flex items-center">
                            <input type="range" min="0" max="5" value="2" class="w-full z-10" id="duration-slider">
                            <div class="absolute w-full flex justify-between px-1 pointer-events-none opacity-30">
                                <div class="w-0.5 h-2 bg-stone-400"></div>
                                <div class="w-0.5 h-1 bg-stone-300"></div>
                                <div class="w-0.5 h-1 bg-stone-300"></div>
                                <div class="w-0.5 h-1 bg-stone-300"></div>
                                <div class="w-0.5 h-1 bg-stone-300"></div>
                                <div class="w-0.5 h-2 bg-stone-400"></div>
                            </div>
                        </div>
                        <div class="flex justify-between text-[10px] text-stone-400 font-bold uppercase tracking-widest mt-2">
                            <span>&lt; 1 month</span>
                            <span>+ 3 years</span>
                        </div>
                    </div>

                    <div id="frequency-container" class="hidden">
                         <label class="text-xs font-bold text-stone-400 uppercase tracking-widest block mb-4 leading-relaxed">How often do blemishes appear?</label>
                         <div class="grid grid-cols-1 gap-2">
                             <button type="button" onclick="setFrequency('1-2 fois / mois', this)" class="freq-btn w-full text-left px-4 py-3 rounded-xl border border-stone-100 bg-stone-50 text-sm text-stone-600 hover:border-brand-primary/30 transition-all">1-2 times / month</button>
                             <button type="button" onclick="setFrequency('1 fois / semaine', this)" class="freq-btn w-full text-left px-4 py-3 rounded-xl border border-stone-100 bg-stone-50 text-sm text-stone-600 hover:border-brand-primary/30 transition-all">1 time / week</button>
                             <button type="button" onclick="setFrequency('Par p&eacute;riodes (stress/cycle)', this)" class="freq-btn w-full text-left px-4 py-3 rounded-xl border border-stone-100 bg-stone-50 text-sm text-stone-600 hover:border-brand-primary/30 transition-all">Periodically (stress/cycle)</button>
                             <button type="button" onclick="setFrequency('Rarement / Quelques fois par an', this)" class="freq-btn w-full text-left px-4 py-3 rounded-xl border border-stone-100 bg-stone-50 text-sm text-stone-600 hover:border-brand-primary/30 transition-all">Rarely / A few times a year</button>
                          </div>
                          <p id="frequency-error" class="text-red-500 text-xs mt-3 hidden flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Selection required</p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-brand-dark font-medium leading-snug pr-2" id="lbl-concerns">What bothers you most about your skin currently?</label>
                        </div>
                        <p class="text-xs text-stone-500 mb-3 leading-relaxed">This answer helps the AI understand your feelings and aspects less visible in photos.</p>
                        <textarea id="skin-concerns" rows="5" class="w-full p-4 rounded-xl bg-white border border-stone-200 text-brand-dark placeholder-stone-300 focus:border-brand-primary focus:outline-none transition-colors text-sm" placeholder="Ex: I have small red bumps on my cheeks and blackheads on my nose. I would also like to smooth my skin texture on the forehead..."></textarea>
                        <p id="concerns-error" class="text-red-500 text-xs mt-2 hidden flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> This field is required.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="step-5" class="step-container">
            <div class="text-center mb-8">
                <span class="text-[10px] font-bold uppercase tracking-widest text-brand-primary mb-2 block">Targeted Zones</span>
                <h2 class="font-serif text-3xl text-brand-dark" id="lbl-zones-title">Which areas concern you the most?</h2>
                 <p class="text-stone-500 font-light mt-2 text-sm hidden" id="lbl-zones-subtitle">Even if occasional, it helps prevention.</p>
                <p id="zones-error" class="text-red-500 text-xs mt-2 hidden flex items-center justify-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Select at least one area.</p>
            </div>

            <div class="flex flex-col md:flex-row items-center md:items-start justify-center gap-8 animate-fade-in">

                <div class="relative w-full max-w-[320px] shrink-0">
                    <svg viewBox="0 0 300 400" class="w-full h-auto drop-shadow-xl" style="max-height: 50vh;">
                        <g transform="translate(0, 10)">
                            <path d="M70,120 C70,50 150,50 150,50 C150,50 230,50 230,120 C230,220 210,290 150,300 C90,290 70,220 70,120" class="sketch-line" stroke="#292524" fill="none"/>
                            <path d="M100,285 Q100,340 80,360 M200,285 Q200,340 220,360" class="sketch-line" stroke-width="0.8" opacity="0.5"/>
                            <path d="M95,145 Q115,135 135,145" class="sketch-line" stroke-width="1"/>
                            <path d="M165,145 Q185,135 205,145" class="sketch-line" stroke-width="1"/>
                            <path d="M150,150 Q145,190 138,200 Q150,210 162,200" class="sketch-line" fill="none" stroke-width="0.8"/>
                            <path d="M125,240 Q150,235 175,240" class="sketch-line" stroke-width="1"/>
                            <path d="M130,245 Q150,255 170,245" class="sketch-line" stroke-width="0.5" opacity="0.6"/>
                        </g>

                        <g transform="translate(0, 10)">
                            <path id="zone-front" class="zone-spot" d="M85,115 Q85,70 150,70 Q215,70 215,115 Q215,125 150,125 Q85,125 85,115 Z" onclick="toggleZone('front')"/>
                            <path id="zone-tempes" class="zone-spot" d="M72,130 Q68,120 82,120 L84,150 Q68,145 72,130 M228,130 Q232,120 218,120 L216,150 Q232,145 228,130" onclick="toggleZone('tempes')"/>
                            <path id="zone-nez" class="zone-spot" d="M138,135 L162,135 L162,205 L145,212 L138,205 Z" onclick="toggleZone('nez')"/>
                            <path id="zone-joue-g" class="zone-spot" d="M80,170 Q115,170 115,215 Q115,230 85,220 Q70,200 80,170 Z" onclick="toggleZone('joues')"/>
                            <path id="zone-joue-d" class="zone-spot" d="M220,170 Q185,170 185,215 Q185,230 215,220 Q230,200 220,170 Z" onclick="toggleZone('joues')"/>
                            <path id="zone-bouche" class="zone-spot" d="M120,230 Q150,225 180,230 Q185,245 180,255 Q150,265 120,255 Q115,245 120,230 Z" style="opacity: 0.8" onclick="toggleZone('bouche')"/>
                            <path id="zone-machoire" class="zone-spot" d="M90,235 Q86,255 103,270 L118,275 Q108,250 98,235 M210,235 Q214,255 197,270 L182,275 Q192,250 202,235" onclick="toggleZone('machoire')"/>
                            <path id="zone-menton" class="zone-spot" d="M125,265 Q150,265 175,265 Q175,290 150,300 Q125,290 125,265 Z" onclick="toggleZone('menton')"/>
                        </g>
                    </svg>
                </div>

                <div class="w-full max-w-[280px] space-y-2">
                    <p class="text-xs font-bold uppercase text-stone-400 mb-3 tracking-widest">Quick Selection</p>
                    <button type="button" onclick="toggleZone('front')" id="btn-front" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left"><span>Forehead</span><div class="indicator w-4 h-4 rounded-full border border-stone-200"></div></button>
                    <button type="button" onclick="toggleZone('tempes')" id="btn-tempes" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left"><span>Temples</span><div class="indicator w-4 h-4 rounded-full border border-stone-200"></div></button>
                    <button type="button" onclick="toggleZone('nez')" id="btn-nez" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left"><span>Nose</span><div class="indicator w-4 h-4 rounded-full border border-stone-200"></div></button>
                    <button type="button" onclick="toggleZone('joues')" id="btn-joues" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left"><span>Cheeks</span><div class="indicator w-4 h-4 rounded-full border border-stone-200"></div></button>
                    <button type="button" onclick="toggleZone('bouche')" id="btn-bouche" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left"><span>Around mouth</span><div class="indicator w-4 h-4 rounded-full border border-stone-200"></div></button>
                    <button type="button" onclick="toggleZone('machoire')" id="btn-machoire" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left"><span>Jawline</span><div class="indicator w-4 h-4 rounded-full border border-stone-200"></div></button>
                    <button type="button" onclick="toggleZone('menton')" id="btn-menton" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left"><span>Chin</span><div class="indicator w-4 h-4 rounded-full border border-stone-200"></div></button>
                    <button type="button" onclick="toggleZone('none')" id="btn-none" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left hidden"><span>No specific area</span><div class="indicator w-4 h-4 rounded-full border border-stone-200"></div></button>
                </div>
            </div>
        </div>

        <div id="step-6" class="step-container">
            <div class="space-y-8 animate-fade-in max-w-xl mx-auto">
                <div>
                    <h2 class="font-serif text-3xl mb-3 text-brand-dark">Context &amp; Habits</h2>
                    <p class="text-stone-500 font-light">For a perfectly adapted protocol.</p>
                </div>

                <div>
                    <label class="text-xs font-bold uppercase text-stone-400 tracking-widest block mb-2" id="lbl-products">Current routine (optional)</label>
                    <textarea id="current-products" class="w-full p-4 rounded-xl bg-white border border-stone-200 text-brand-dark placeholder-stone-300 focus:border-brand-primary focus:outline-none transition-colors" rows="3" placeholder="Ex: La Roche-Posay Effaclar cleanser, CeraVe moisturizer, ..."></textarea>
                </div>

                <div class="mb-10">
                    <label class="text-xs font-bold uppercase text-stone-400 tracking-widest block mb-3 leading-relaxed" id="lbl-factors">Which of these factors affect you most recently?</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button type="button" onclick="toggleFactor(this, 'stress')" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left group">
                            <span class="font-medium group-[.selected]:text-brand-dark">High stress</span>
                            <div class="indicator w-4 h-4 rounded-full border border-stone-200"></div>
                        </button>

                        <button type="button" onclick="toggleFactor(this, 'cycle')" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left group">
                            <span class="font-medium group-[.selected]:text-brand-dark">Hormonal cycle</span>
                            <div class="indicator w-4 h-4 rounded-full border border-stone-200"></div>
                        </button>

                        <button type="button" onclick="toggleFactor(this, 'sweat')" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left group">
                            <span class="font-medium group-[.selected]:text-brand-dark">Sweat (sports)</span>
                            <div class="indicator w-4 h-4 rounded-full border border-stone-200"></div>
                        </button>

                         <button type="button" onclick="toggleFactor(this, 'diet')" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left group">
                            <span class="font-medium group-[.selected]:text-brand-dark">Diet / Excess (sugar, alcohol)</span>
                            <div class="indicator w-4 h-4 rounded-full border border-stone-200"></div>
                        </button>

                         <button type="button" onclick="toggleFactor(this, 'sleep')" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left group">
                            <span class="font-medium group-[.selected]:text-brand-dark">Lack of sleep</span>
                            <div class="indicator w-4 h-4 rounded-full border border-stone-200"></div>
                        </button>

                         <button type="button" onclick="toggleFactor(this, 'shave')" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left group">
                            <span class="font-medium group-[.selected]:text-brand-dark">Friction / Shaving</span>
                            <div class="indicator w-4 h-4 rounded-full border border-stone-200"></div>
                        </button>

                         <button type="button" onclick="toggleFactor(this, 'products')" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left group">
                            <span class="font-medium group-[.selected]:text-brand-dark">Change of products</span>
                            <div class="indicator w-4 h-4 rounded-full border border-stone-200"></div>
                        </button>

                        <button type="button" onclick="toggleFactor(this, 'nothing')" class="zone-item w-full flex items-center justify-between px-4 py-3 rounded-xl border border-stone-100 bg-white text-sm text-stone-500 hover:border-brand-primary/30 text-left group">
                            <span class="font-medium group-[.selected]:text-brand-dark">Nothing in particular</span>
                            <div class="indicator w-4 h-4 rounded-full border border-stone-200"></div>
                        </button>
                    </div>
                </div>

                <div class="space-y-3 p-4 rounded-xl bg-stone-50 border border-stone-100" id="allergies-container">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-brand-dark">Do you have any known allergies? <span class="text-brand-primary">*</span></label>
                        <div class="flex gap-2 bg-stone-200/50 p-1 rounded-lg" id="btn-group-allergies">
                            <button type="button" class="px-3 py-1 rounded-md text-xs font-bold text-stone-400 transition-all bg-white hover:text-brand-dark hover:text-white shadow-sm" onclick="toggleDetails('allergies', true, this)">YES</button>
                            <button type="button" class="px-3 py-1 rounded-md text-xs font-bold text-stone-400 transition-all bg-white hover:text-brand-dark hover:text-white shadow-sm" onclick="toggleDetails('allergies', false, this)">NO</button>
                        </div>
                    </div>
                    <div id="allergies-detail" class="hidden animate-fade-in">
                        <input type="text" id="allergies-input" placeholder="Specify (ex: Aspirin, nuts...)" class="w-full p-3 rounded-lg bg-white border border-stone-200 text-sm focus:border-brand-primary focus:outline-none">
                    </div>
                    <p id="error-allergies" class="text-red-500 text-xs hidden flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Please answer yes or no.</p>
                    <p id="error-allergies-empty" class="text-red-500 text-xs hidden flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Please specify your allergies.</p>
                </div>

                <div class="space-y-3 p-4 rounded-xl bg-stone-50 border border-stone-100" id="treatment-container">
                    <div class="flex items-center justify-between">
                         <div class="pr-2">
                            <label class="text-sm font-medium text-brand-dark block" id="lbl-treatment">Acne treatment? <span class="text-brand-primary">*</span></label>
                            <span class="text-[10px] text-stone-400">Past or present</span>
                         </div>
                        <div class="flex gap-2 bg-stone-200/50 p-1 rounded-lg shrink-0" id="btn-group-treatment">
                            <button type="button" class="px-3 py-1 rounded-md text-xs font-bold text-stone-400 transition-all bg-white hover:text-brand-dark hover:text-white shadow-sm" onclick="toggleDetails('treatment', true, this)">YES</button>
                            <button type="button" class="px-3 py-1 rounded-md text-xs font-bold text-stone-400 transition-all bg-white hover:text-brand-dark hover:text-white shadow-sm" onclick="toggleDetails('treatment', false, this)">NO</button>
                        </div>
                    </div>
                    <div id="treatment-detail" class="hidden animate-fade-in">
                        <input type="text" id="treatment-input" placeholder="Specify (ex: Accutane 2 years ago, antibiotics...)" class="w-full p-3 rounded-lg bg-white border border-stone-200 text-sm focus:border-brand-primary focus:outline-none">
                    </div>
                    <p id="error-treatment" class="text-red-500 text-xs hidden flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Please answer yes or no.</p>
                    <p id="error-treatment-empty" class="text-red-500 text-xs hidden flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Please specify your treatment.</p>
                </div>
            </div>
        </div>

        <div id="step-7" class="step-container">
            <div class="space-y-8 animate-fade-in max-w-xl mx-auto">
                 <div>
                    <h2 class="font-serif text-3xl mb-3 text-brand-dark">Last Step</h2>
                    <p class="text-stone-500 font-light">Before starting the analysis.</p>
                </div>

                <div>
                    <label class="block text-brand-dark font-medium mb-1">Anything else to add?</label>
                    <textarea id="extra-notes" rows="4" class="w-full p-4 rounded-xl bg-white border border-stone-200 text-brand-dark placeholder-stone-300 focus:border-brand-primary focus:outline-none transition-colors" placeholder="Additional details..."></textarea>
                </div>

                <div class="space-y-4 pt-4 border-t border-stone-200/50">
                    <div class="flex items-center justify-between">
                        <label class="text-xs font-bold text-stone-400 uppercase tracking-widest">Email (Required)</label>
                    </div>
                    <input type="email" id="email" placeholder="Your email address" class="w-full p-4 rounded-xl bg-white border border-stone-200 text-brand-dark placeholder-stone-400 focus:border-brand-primary focus:outline-none transition-colors">
                    <input type="email" id="email-confirm" placeholder="Confirm your email" class="w-full p-4 rounded-xl bg-white border border-stone-200 text-brand-dark placeholder-stone-400 focus:border-brand-primary focus:outline-none transition-colors">

                    <p id="email-error-empty" class="text-red-500 text-xs hidden flex items-center gap-1"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Email is required.</p>
                    <p id="email-error-match" class="text-red-500 text-xs hidden flex items-center gap-1"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Emails do not match.</p>
                </div>

                <div class="bg-stone-50 p-6 rounded-2xl border-2 border-stone-300 shadow-sm" id="privacy-container">
                    <h3 class="font-serif text-lg text-brand-dark mb-2">Privacy and respect for your data</h3>
                    <p class="text-xs text-stone-500 leading-relaxed mb-4">
                        Your information is used to generate your analysis and contributes to improving our AI (strictly anonymously). It remains confidential.
                    </p>

                    <label class="flex items-start gap-3 cursor-pointer group">
                        <div class="relative flex items-center justify-center shrink-0 w-7 h-7 mt-0.5">
                            <input type="checkbox" id="privacy-check" required class="peer appearance-none absolute inset-0 w-full h-full z-30 cursor-pointer opacity-0">
                            <div class="absolute inset-0 rounded bg-white peer-checked:bg-brand-primary peer-checked:border-brand-primary transition-all pointer-events-none"
                                 style="border: 1px solid #000000;">
                            </div>
                            <svg class="absolute w-5 h-5 text-white pointer-events-none hidden peer-checked:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </div>
                        <span class="text-sm text-stone-700 font-medium group-hover:text-brand-dark transition-colors">
                            I have read and accept the
                            <a href="https://adermio.com/en/conditions" target="_blank" rel="noopener noreferrer" class="underline underline-offset-2 decoration-stone-300 hover:decoration-brand-primary" onclick="event.stopPropagation()">
                                Terms of Service
                            </a>
                            and the
                            <a href="https://adermio.com/en/confidentialite" target="_blank" rel="noopener noreferrer" class="underline underline-offset-2 decoration-stone-300 hover:decoration-brand-primary" onclick="event.stopPropagation()">
                                Privacy Policy
                            </a>.
                        </span>
                    </label>
                    <p id="privacy-error" class="text-red-500 text-xs mt-2 hidden flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> You must accept the privacy policy.</p>
                </div>

                <div class="h-20"></div>
            </div>
        </div>

        <div id="step-8" class="step-container">
             <div class="flex flex-col items-center justify-center text-center py-20 animate-fade-in">

                <div class="w-20 h-20 rounded-full bg-brand-light flex items-center justify-center mb-8 animate-bounce">
                    <i data-lucide="check" class="w-10 h-10 text-brand-primary"></i>
                </div>

                <h1 class="font-serif text-4xl mb-6 text-brand-dark">Thank you!</h1>

                <p class="text-lg text-brand-dark font-medium mb-2">
                    Your data has been sent successfully.
                </p>
                <p class="text-stone-500 font-light mb-12">
                    Analysis in progress, please wait for redirection...
                </p>
            </div>
        </div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 p-6 z-[100] transition-transform duration-500" id="nav-bar">
        <div class="max-w-xl mx-auto flex items-center gap-4">
            <button id="btn-back" class="w-14 h-14 rounded-full bg-white border border-stone-200 text-stone-400 flex items-center justify-center shadow-lg shadow-stone-200/50 hover:bg-stone-50 active:scale-95 transition-all hidden">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>

            <button id="btn-next" class="flex-1 h-14 rounded-full bg-brand-dark text-white shadow-xl shadow-brand-dark/20 flex items-center justify-center gap-3 hover:bg-brand-dark/90 active:scale-[0.98] transition-all group overflow-hidden relative">
                <span class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-full"></span>
                <span id="btn-text" class="text-sm font-bold uppercase tracking-widest relative z-10">START</span>
                <i data-lucide="arrow-right" class="w-4 h-4 relative z-10 group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- CONFIGURATION ---
        const WEBHOOK_URL = 'https://n8n.adermio.com/webhook/free_analysis_en/new';
        const PRESIGN_URL = 'https://api.adermio.com/v2/uploads/presign';
        const UPLOAD_LOG_URL = "https://n8n.adermio.com/webhook/upload-log";
        const MAX_IMAGE_MB = 25;

        // --- GLOBAL STATE ---
        const totalSteps = 7;
        let currentStep = 1;

        // Anti double submit
        let isSubmitting = false;

        // --- JOB ID GENERATION ---
        function adermioGenerateJobId() {
            const randomPart = Math.random().toString(36).substring(2, 10);
            const timePart = Date.now().toString(36);
            return "job_" + timePart + "_" + randomPart;
        }

        let currentJobId = adermioGenerateJobId();
        try { localStorage.setItem("adermio_jobId", currentJobId); } catch(e){}
        console.log("\u2705 jobId generated :", currentJobId);

        const formState = {
            jobId: currentJobId,
            name: '',
            gender: 'femme',
            age: 24,
            photos: {
                face: { key: null, getUrl: null },
                left: { key: null, getUrl: null },
                right: { key: null, getUrl: null },
                zoom: { key: null, getUrl: null }
            },
            goal: 'correction',
            duration: '3-6 months',
            frequency: '',
            concerns: '',
            zones: [],
            currentProducts: '',
            factors: [],
            allergies: {
                has: false,
                detail: ''
            },
            treatment: {
                has: false,
                detail: ''
            },
            extraNotes: '',
            email: ''
        };

        const validationState = {
            facePhotoUploaded: false,
            allergiesAnswered: false,
            treatmentAnswered: false
        };

        // --- DOM ELEMENTS ---
        const btnNext = document.getElementById('btn-next');
        const btnBack = document.getElementById('btn-back');
        const btnText = document.getElementById('btn-text');
        const progressContainer = document.getElementById('progress-container');
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- PROGRESS & NAVIGATION UI ---
        function initProgress() {
            progressContainer.innerHTML = '';
            for(let i = 1; i <= totalSteps; i++) {
                const dot = document.createElement('div');
                dot.className = `h-1 rounded-full transition-all duration-500 ${i === 1 ? 'w-8 bg-brand-dark' : 'w-2 bg-stone-200'}`;
                dot.id = `dot-${i}`;
                progressContainer.appendChild(dot);
            }
        }
        initProgress();

        function updateUI() {
            for(let i = 1; i <= totalSteps; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if(i <= currentStep) {
                    dot.classList.remove('bg-stone-200', 'w-2');
                    dot.classList.add('bg-brand-dark');
                    dot.classList.toggle('w-8', i === currentStep);
                    dot.classList.toggle('w-2', i !== currentStep);
                } else {
                    dot.classList.remove('bg-brand-dark', 'w-8');
                    dot.classList.add('bg-stone-200', 'w-2');
                }
            }

            if(currentStep === 1) {
                btnBack.classList.add('hidden');
                btnText.textContent = "START";
            } else if (currentStep === totalSteps) {
                btnBack.classList.remove('hidden');
                btnText.textContent = "START ANALYSIS";
            } else {
                btnBack.classList.remove('hidden');
                btnText.textContent = "CONTINUE";
            }
        }

        function goToStep(step) {
            const currentEl = document.getElementById(`step-${currentStep}`);
            if(!currentEl) return;

            currentEl.style.opacity = '0';
            currentEl.style.pointerEvents = 'none';

            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;

            setTimeout(() => {
                currentEl.classList.remove('active');

                currentStep = step;
                const nextEl = document.getElementById(`step-${currentStep}`);
                if(nextEl) {
                    nextEl.classList.add('active');
                    void nextEl.offsetWidth;
                    nextEl.style.opacity = '1';
                    nextEl.style.pointerEvents = 'all';
                }
                updateUI();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 300);
        }

        function showSuccessStep() {
            const currentEl = document.getElementById(`step-${currentStep}`);
            currentEl?.classList.remove('active');
            currentEl && (currentEl.style.opacity = '0');
            document.getElementById('step-8')?.classList.add('active');
        }

        // --- GOAL & FREQUENCY LOGIC ---
        window.setGoal = function(goal) {
            formState.goal = goal;

            document.getElementById('btn-goal-correction').classList.toggle('selected', goal === 'correction');
            document.getElementById('btn-goal-stabilisation').classList.toggle('selected', goal === 'stabilisation');
            document.getElementById('btn-goal-correction').classList.toggle('border-stone-200', goal !== 'correction');
            document.getElementById('btn-goal-stabilisation').classList.toggle('border-stone-200', goal !== 'stabilisation');

            const durationCont = document.getElementById('duration-container');
            const frequencyCont = document.getElementById('frequency-container');
            const concernsTextarea = document.getElementById('skin-concerns');
            const concernsLabel = document.getElementById('lbl-concerns');

            if(goal === 'correction') {
                durationCont.classList.remove('hidden');
                frequencyCont.classList.add('hidden');
                concernsTextarea.placeholder = "Ex: I have small red bumps on my cheeks and blackheads on my nose. I would also like to smooth my skin texture on the forehead...";
                concernsLabel.textContent = "What bothers you most about your skin currently?";
            } else {
                durationCont.classList.add('hidden');
                frequencyCont.classList.remove('hidden');
                concernsTextarea.placeholder = "Ex: My skin is OK but 1-2 spots on my chin before my period. I want to smooth texture and avoid surprise pimples...";
                concernsLabel.textContent = "Is there an aspect of your skin you would like to improve?";
            }

            const zonesTitle = document.getElementById('lbl-zones-title');
            const zonesSubtitle = document.getElementById('lbl-zones-subtitle');
            const btnNone = document.getElementById('btn-none');

            if(goal === 'correction') {
                zonesTitle.textContent = "Which areas concern you the most?";
                zonesSubtitle.classList.add('hidden');
                btnNone.classList.add('hidden');
                if(formState.zones.includes('none')) {
                    toggleZone('none');
                }
            } else {
                zonesTitle.textContent = "Which areas sometimes get blemishes?";
                zonesSubtitle.classList.remove('hidden');
                btnNone.classList.remove('hidden');
            }

            const factorsLabel = document.getElementById('lbl-factors');
            const treatmentLabel = document.getElementById('lbl-treatment');
            const treatmentInput = document.getElementById('treatment-input');

            if(goal === 'correction') {
                 factorsLabel.textContent = "Which of these factors affect you most recently?";
                 treatmentLabel.innerHTML = 'Acne treatment? <span class="text-brand-primary">*</span>';
                 treatmentInput.placeholder = "Specify (ex: Accutane 2 years ago, antibiotics...)";
            } else {
                 factorsLabel.textContent = "In which situations do blemishes appear most often?";
                 treatmentLabel.innerHTML = 'Do you use a medical treatment (ex: prescription cream)? <span class="text-brand-primary">*</span>';
                 treatmentInput.placeholder = "Specify (ex: Antibiotic cream, Benzoyl Peroxide...)";
            }
        }

        window.setFrequency = function(val, btn) {
            formState.frequency = val;
            document.querySelectorAll('.freq-btn').forEach(b => {
                b.classList.remove('bg-brand-primary/10', 'border-brand-primary', 'text-brand-dark');
                b.classList.add('bg-stone-50', 'border-stone-100', 'text-stone-600');
            });
            btn.classList.remove('bg-stone-50', 'border-stone-100', 'text-stone-600');
            btn.classList.add('bg-brand-primary/10', 'border-brand-primary', 'text-brand-dark');
            document.getElementById('frequency-error').classList.add('hidden');
        }

        // --- DATA COLLECTION & VALIDATION ---
        function collectAndValidateStep() {
            try {
                if(currentStep === 1) {
                    const input = document.getElementById('input-name');
                    const err = document.getElementById('error-message');

                    if(input.value.trim().length < 2) {
                        showError('name-input-container', 'error-message');
                        return false;
                    }

                    err.classList.add('hidden');
                    formState.name = input.value.trim();
                    document.querySelectorAll('.user-name-display').forEach(el => el.textContent = formState.name);
                }

                if(currentStep === 2) {
                    const genderEl = document.querySelector('input[name="gender"]:checked');
                    if(genderEl) formState.gender = genderEl.value;
                }

                if(currentStep === 3) {
                    if(!validationState.facePhotoUploaded) {
                        document.getElementById('photo-error').classList.remove('hidden');
                        return false;
                    }
                }

                if(currentStep === 4) {
                    if(formState.goal === 'stabilisation' && formState.frequency === '') {
                          document.getElementById('frequency-error').classList.remove('hidden');
                          return false;
                    }

                    const concerns = document.getElementById('skin-concerns');
                    if(concerns.value.trim() === '') {
                        concerns.classList.add('input-error');
                        document.getElementById('concerns-error').classList.remove('hidden');
                        setTimeout(() => concerns.classList.remove('input-error'), 1000);
                        return false;
                    }
                    formState.concerns = concerns.value.trim();
                    document.getElementById('concerns-error').classList.add('hidden');
                }

                if(currentStep === 5) {
                    if(formState.zones.length === 0) {
                        const error = document.getElementById('zones-error');
                        error.classList.remove('hidden');
                        error.parentElement.classList.add('animate-shake');
                        setTimeout(() => error.parentElement.classList.remove('animate-shake'), 1000);
                        return false;
                    }
                    document.getElementById('zones-error').classList.add('hidden');
                }

                if(currentStep === 6) {
                    formState.currentProducts = document.getElementById('current-products').value.trim();

                    const allergiesInput = document.getElementById('allergies-input');
                    if(!validationState.allergiesAnswered) {
                        document.getElementById('error-allergies').classList.remove('hidden');
                        return false;
                    } else {
                        document.getElementById('error-allergies').classList.add('hidden');
                    }

                    if(formState.allergies.has && allergiesInput.value.trim() === '') {
                        document.getElementById('error-allergies-empty').classList.remove('hidden');
                        return false;
                    }
                    formState.allergies.detail = allergiesInput.value.trim();
                    document.getElementById('error-allergies-empty').classList.add('hidden');

                    const treatmentInput = document.getElementById('treatment-input');
                    if(!validationState.treatmentAnswered) {
                        document.getElementById('error-treatment').classList.remove('hidden');
                        return false;
                    } else {
                        document.getElementById('error-treatment').classList.add('hidden');
                    }

                    if(formState.treatment.has && treatmentInput.value.trim() === '') {
                        document.getElementById('error-treatment-empty').classList.remove('hidden');
                        return false;
                    }
                    formState.treatment.detail = treatmentInput.value.trim();
                    document.getElementById('error-treatment-empty').classList.add('hidden');
                }

                if(currentStep === 7) {
                    formState.extraNotes = document.getElementById('extra-notes').value.trim();

                    const emailInput = document.getElementById('email');
                    const confirmInput = document.getElementById('email-confirm');
                    const email = emailInput.value.trim();
                    const confirm = confirmInput.value.trim();

                    document.getElementById('email-error-empty').classList.add('hidden');
                    document.getElementById('email-error-match').classList.add('hidden');
                    emailInput.classList.remove('input-error');

                    if (email === "") {
                        document.getElementById('email-error-empty').classList.remove('hidden');
                        emailInput.classList.add('input-error');
                        return false;
                    }

                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if(!emailRegex.test(email) || email !== confirm) {
                        document.getElementById('email-error-match').classList.remove('hidden');
                        return false;
                    }
                    formState.email = email;

                    const privacy = document.getElementById('privacy-check');
                    const privacyError = document.getElementById('privacy-error');

                    if(!privacy.checked) {
                        const container = document.getElementById('privacy-container');
                        container.classList.add('animate-shake');
                        privacyError.classList.remove('hidden');
                        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => container.classList.remove('animate-shake'), 1000);
                        return false;
                    } else {
                        privacyError.classList.add('hidden');
                    }
                }
                return true;
            } catch(e) {
                console.error("Validation error :", e);
                return currentStep === 7 ? true : false;
            }
        }

        function showError(containerId, errorId) {
            const container = document.getElementById(containerId);
            const error = document.getElementById(errorId);
            container.classList.add('animate-shake');
            error.classList.remove('hidden');
            setTimeout(() => container.classList.remove('animate-shake'), 1000);
        }

        // --- EVENT LISTENERS ---
        btnNext.addEventListener('click', (e) => {
            if(!collectAndValidateStep()) {
                e.preventDefault();
                return;
            }

            e.preventDefault();

            if(currentStep < totalSteps) {
                goToStep(currentStep + 1);
            } else {
                submitFormData();
            }
        });

        btnBack.addEventListener('click', (e) => {
            e.preventDefault();
            if(currentStep > 1) goToStep(currentStep - 1);
        });

        const nameInputEl = document.getElementById('input-name');
        nameInputEl.addEventListener('input', () => {
            document.getElementById('error-message').classList.add('hidden');
        });
        nameInputEl.addEventListener('keyup', (e) => { if(e.key === 'Enter') btnNext.click(); });

        const ageSlider = document.getElementById('age-slider');
        const ageInlineInput = document.getElementById('age-inline-input');

        function clampAge(v) {
            const n = parseInt(v, 10);
            if (Number.isNaN(n)) return 24;
            return Math.min(65, Math.max(12, n));
        }

        ageSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            ageInlineInput.value = val;
            formState.age = val;
        });

        ageInlineInput.addEventListener('input', (e) => {
            const val = clampAge(e.target.value);
            if (e.target.value === "" || e.target.value === "-" ) return;
            ageSlider.value = String(val);
            formState.age = String(val);
        });

        ageInlineInput.addEventListener('blur', (e) => {
            const val = clampAge(e.target.value);
            ageInlineInput.value = String(val);
            ageSlider.value = String(val);
            formState.age = String(val);
        });


/* =========================================================
   PRESIGN + DIRECT S3 UPLOAD (PERMISSIVE V2 LOGIC)
   ========================================================= */

function logUploadEvent(event, detail) {
  try {
    fetch(UPLOAD_LOG_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        event,
        detail,
        jobId: formState.jobId,
        ua: navigator.userAgent,
        ts: Date.now(),
      }),
    });
  } catch (_) {}
}

function getFileExt(name) {
  const m = String(name || "").toLowerCase().match(/\.([a-z0-9]+)$/);
  return m ? m[1] : "";
}

/**
 * Accept any image type - the server-side normalizer (sharp) handles conversion.
 * We check MIME + a broad set of known image extensions as fallback.
 */
function isProbablyImage(file) {
  const mime = String(file?.type || "").toLowerCase();
  if (mime.startsWith("image/")) return true;

  // Some browsers don't report MIME for HEIC/HEIF/RAW  check extension
  const ext = getFileExt(file?.name);
  const allowed = new Set([
    "jpg", "jpeg", "png",
    "heic", "heif", "heics",
    "webp", "gif",
    "bmp", "tif", "tiff",
    "avif",
    "dng", "cr2", "nef", "arw", "raw", "orf", "rw2", "sr2",
    "svg", "ico", "jfif", "pjpeg", "pjp"
  ]);
  return allowed.has(ext);
}

function getSafeContentType(file) {
  const mime = String(file?.type || "").toLowerCase();
  if (mime.startsWith("image/")) return mime;
  return "application/octet-stream";
}

async function uploadToS3Presigned({ file, jobId, type }) {
  const safeContentType = getSafeContentType(file);

  const presignResp = await fetch(PRESIGN_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      jobId,
      type,
      contentType: safeContentType,
      size: file.size,
      originalName: file.name || ""
    }),
  });

  if (!presignResp.ok) {
    const errText = await presignResp.text().catch(() => "");
    logUploadEvent("presign_failed", {
      type,
      status: presignResp.status,
      message: errText,
      mime: file.type || "",
      size: file.size,
      name: file.name || ""
    });
    throw new Error(`Presign failed: ${presignResp.status} ${errText}`);
  }

  const { putUrl, key, getUrl } = await presignResp.json();

  const putResp = await fetch(putUrl, {
    method: "PUT",
    body: file,
  });

  if (!putResp.ok) {
    const errText = await putResp.text().catch(() => "");
    throw new Error(`S3 PUT failed: ${putResp.status} ${errText}`);
  }

  return { key, getUrl };
}

window.handleImageUpload = async function (input, previewId, overlayId, emptyId) {
  if (!(input && input.files && input.files[0])) return;

  const file = input.files[0];
  const type = input.dataset.type;

  if (file.size > MAX_IMAGE_MB * 1024 * 1024) {
    document.getElementById("file-type-error")?.classList.add("hidden");
    logUploadEvent("too_large", { type, size: file.size, name: file.name || "", mime: file.type || "" });
    alert(`Photo too large (max ${MAX_IMAGE_MB}MB). Please try a smaller photo.`);
    input.value = "";
    return;
  }

  if (!isProbablyImage(file)) {
    document.getElementById("file-type-error")?.classList.remove("hidden");
    logUploadEvent("not_image", { type, size: file.size, name: file.name || "", mime: file.type || "" });
    input.value = "";
    return;
  }
  document.getElementById("file-type-error")?.classList.add("hidden");

  try {
    const reader = new FileReader();
    reader.onload = (e) => {
      document.getElementById(emptyId)?.classList.add("hidden");
      const img = document.getElementById(previewId);
      if (img) {
        img.src = e.target.result;
        img.classList.remove("hidden");
      }
    };
    reader.onerror = () => {};
    reader.readAsDataURL(file);
  } catch (_) {}

  const overlay = document.getElementById(overlayId);
  overlay?.classList.remove("hidden");
  overlay?.classList.add("flex");

  try {
    const { key, getUrl } = await uploadToS3Presigned({
      file,
      jobId: formState.jobId,
      type,
    });

    formState.photos[type] = { key, getUrl };

    if (type === "face") {
      validationState.facePhotoUploaded = true;
      document.getElementById("photo-error")?.classList.add("hidden");
    }

    logUploadEvent("upload_ok", {
      type,
      key,
      mime: file.type || "",
      size: file.size,
      name: file.name || ""
    });
  } catch (err) {
    console.error("\u274c Upload failed:", err);

    if (type === "face") {
      validationState.facePhotoUploaded = false;
      document.getElementById("photo-error")?.classList.remove("hidden");
    }
    formState.photos[type] = { key: null, getUrl: null };

    try {
      const img = document.getElementById(previewId);
      const empty = document.getElementById(emptyId);
      if (img) {
        img.src = "";
        img.classList.add("hidden");
      }
      empty?.classList.remove("hidden");
      input.value = "";
    } catch (_) {}

    logUploadEvent("upload_failed", {
      type,
      mime: file.type || "",
      size: file.size,
      name: file.name || "",
      message: String(err?.message || err),
    });

    alert("Unable to upload photo. Please check your connection and try again.");
  } finally {
    overlay?.classList.add("hidden");
    overlay?.classList.remove("flex");
  }
};


        window.toggleZoomArea = function() {
            const area = document.getElementById('zoom-area');
            const btn = document.getElementById('toggle-zoom-btn');
            if(area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                btn.innerHTML = '<i data-lucide="minus" class="w-4 h-4"></i> Hide area';
            } else {
                area.classList.add('hidden');
                btn.innerHTML = '<i data-lucide="plus" class="w-4 h-4"></i> Add zoom area (Optional)';
                formState.photos.zoom = { key: null, getUrl: null };
            }
            lucide.createIcons();
        }

        const durationSlider = document.getElementById('duration-slider');
        const durationLabels = ["< 1 month", "1-3 months", "3-6 months", "6-12 months", "1-3 years", "+ 3 years"];
        if(durationSlider) {
            durationSlider.addEventListener('input', (e) => {
                const index = parseInt(e.target.value);
                const label = durationLabels[index] || "";
                document.getElementById('duration-display').textContent = label;
                formState.duration = label;
            });
        }

        window.toggleZone = function(zoneId) {
            if (zoneId === 'none') {
                formState.zones.forEach(z => {
                    if(z !== 'none') {
                        const btn = document.getElementById(`btn-${z}`);
                        const svg = document.getElementById(`zone-${z}`);
                        if(btn) btn.classList.remove('selected');
                        if(svg) svg.classList.remove('selected');
                        if(z === 'joues') {
                             document.getElementById('zone-joue-g')?.classList.remove('selected');
                             document.getElementById('zone-joue-d')?.classList.remove('selected');
                        }
                    }
                });

                if (formState.zones.includes('none')) {
                      formState.zones = [];
                      document.getElementById('btn-none').classList.remove('selected');
                } else {
                      formState.zones = ['none'];
                      document.getElementById('btn-none').classList.add('selected');
                }
            } else {
                if (formState.zones.includes('none')) {
                    formState.zones = [];
                    document.getElementById('btn-none').classList.remove('selected');
                }

                const svgEl = document.getElementById(`zone-${zoneId}`);
                const btnEl = document.getElementById(`btn-${zoneId}`);

                if(formState.zones.includes(zoneId)) {
                    formState.zones = formState.zones.filter(z => z !== zoneId);
                    if(zoneId === 'joues') {
                        document.getElementById('zone-joue-g').classList.remove('selected');
                        document.getElementById('zone-joue-d').classList.remove('selected');
                    } else if(svgEl) {
                        svgEl.classList.remove('selected');
                    }
                    if(btnEl) btnEl.classList.remove('selected');
                } else {
                    formState.zones.push(zoneId);
                    if(zoneId === 'joues') {
                        document.getElementById('zone-joue-g').classList.add('selected');
                        document.getElementById('zone-joue-d').classList.add('selected');
                    } else if(svgEl) {
                        svgEl.classList.add('selected');
                    }
                    if(btnEl) btnEl.classList.add('selected');
                }
            }

            if(formState.zones.length > 0) {
                document.getElementById('zones-error').classList.add('hidden');
            }
        }

        window.toggleFactor = function(btnElement, factorValue) {
  if (factorValue === "nothing") {
    formState.factors = formState.factors.includes("nothing") ? [] : ["nothing"];
    document.querySelectorAll('[onclick^="toggleFactor"]').forEach(b => b.classList.remove("selected"));
    if (formState.factors.includes("nothing")) btnElement.classList.add("selected");
    return;
  }

  if (formState.factors.includes("nothing")) {
    formState.factors = formState.factors.filter(f => f !== "nothing");
    document.querySelectorAll('[onclick="toggleFactor(this, \'nothing\')"]').forEach(b => b.classList.remove("selected"));
  }

  if(formState.factors.includes(factorValue)) {
    formState.factors = formState.factors.filter(f => f !== factorValue);
    btnElement.classList.remove('selected');
  } else {
    formState.factors.push(factorValue);
    btnElement.classList.add('selected');
  }
}


        window.toggleDetails = function(type, isYes, btnElement) {
            const detailDiv = document.getElementById(`${type}-detail`);
            const parent = btnElement.parentElement;

            if(type === 'allergies') validationState.allergiesAnswered = true;
            if(type === 'treatment') validationState.treatmentAnswered = true;

            if(type === 'allergies') formState.allergies.has = isYes;
            if(type === 'treatment') formState.treatment.has = isYes;

            parent.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('bg-brand-dark', 'text-white');
                btn.classList.add('bg-white', 'text-stone-400');
            });
            btnElement.classList.remove('bg-white', 'text-stone-400');
            btnElement.classList.add('bg-brand-dark', 'text-white');

            if(isYes) {
                detailDiv.classList.remove('hidden');
            } else {
                detailDiv.classList.add('hidden');
                const input = document.getElementById(`${type}-input`);
                if(input) input.value = '';
            }
        }

// --- SUBMISSION TO WEBHOOK ---
async function submitFormData() {
  if (isSubmitting) return;
  isSubmitting = true;
  btnNext.disabled = true;

  loadingOverlay.classList.remove('hidden');
  loadingOverlay.classList.add('flex');

  const genderMap = { femme: "Female", homme: "Male", autre: "Other" };

  const zoneLabel = {
    front: "Forehead",
    tempes: "Temples",
    nez: "Nose",
    joues: "Cheeks",
    bouche: "Around mouth",
    machoire: "Jawline",
    menton: "Chin",
    none: "No specific area"
  };

  const factorLabel = {
    stress: "High stress",
    sleep: "Lack of sleep",
    cycle: "Hormonal cycle",
    diet: "Diet / Excess",
    sweat: "Sweat (sports)",
    shave: "Friction / Shaving",
    products: "Change of products",
    nothing: "Nothing in particular"
  };

  const zonesText = (formState.zones || []).map(z => zoneLabel[z] || z).join("; ");
  const factorsText = (formState.factors || []).map(f => factorLabel[f] || f).join("; ");

  const file_face = formState.photos.face.getUrl || "";
  const file_left = formState.photos.left.getUrl || "";
  const file_right = formState.photos.right.getUrl || "";
  const file_zoom = formState.photos.zoom.getUrl || "";

  const sourceKey_face = formState.photos.face.key || "";
  const sourceKey_left = formState.photos.left.key || "";
  const sourceKey_right = formState.photos.right.key || "";
  const sourceKey_zoom = formState.photos.zoom.key || "";

  const emailInput = document.getElementById("email");
  const confirmInput = document.getElementById("email-confirm");
  const Email = (emailInput?.value || "").trim();
  const Email_2 = (confirmInput?.value || "").trim();

  const allergie = formState.allergies.has ? "Yes" : "No";
  const allergie_oui = formState.allergies.has ? (formState.allergies.detail || "") : "";

  const traitement = formState.treatment.has ? "Yes" : "No";
  const traitement_oui = formState.treatment.has ? (formState.treatment.detail || "") : "";

  const sexe = genderMap[formState.gender] || "Other";
  const age = String(formState.age ?? "");

  const mode_diagnostic = formState.goal === 'correction' ? "Correction" : "Stabilization";

  const plainte_patient = formState.concerns || "";
  const produits = formState.currentProducts || "";
  const info_suppl = formState.extraNotes || "";

  const name = formState.name || "";
  const jobId = formState.jobId || "";

  const params = new URLSearchParams();

  params.append("name", name);
  params.append("age", age);
  params.append("sexe", sexe);
  params.append("Email", Email);
  params.append("Email_2", Email_2);
  params.append("jobId", jobId);
  params.append("mode_diagnostic", mode_diagnostic);

  params.append("file", file_face);
  params.append("file_face", file_face);
  params.append("file_left", file_left);
  params.append("file_right", file_right);
  params.append("file_zoom", file_zoom);

  params.append("sourceKey_face", sourceKey_face);
  params.append("sourceKey_left", sourceKey_left);
  params.append("sourceKey_right", sourceKey_right);
  params.append("sourceKey_zoom", sourceKey_zoom);

  if (formState.goal === 'correction') {
      params.append("_Depuis_combien_de_temps_votre_acn\u00e9_est-elle_pr\u00e9sente_", formState.duration || "");
  } else {
      params.append("frequence_imperfections", formState.frequency || "");
  }

  params.append("Quelles_zones_vous_pr\u00e9occupent_le_plus_", zonesText);

  params.append("plainte_patient", plainte_patient);
  params.append("_Quels_produits_utilisez-vous_actuellement_", produits);
  params.append("_Parmi_ces_facteurs_lesquels_vous_concernent_le_plus_ces_derniers_mois_", factorsText);

  params.append("allergie", allergie);
  params.append("allergie_oui", allergie_oui);

  params.append("traitement", traitement);
  params.append("traitement_oui", traitement_oui);

  params.append("info_suppl", info_suppl);

  params.append("consentement", "yes");
  params.append("formid", "form1380783333");
  params.append("tranid", "");

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: params.toString(),
    });

    if (!response.ok) {
      if (response.status === 413) {
        throw new Error("413");
      }
      throw new Error(`Webhook failed: ${response.status}`);
    }

    setTimeout(() => {
      loadingOverlay.classList.add("hidden");
      loadingOverlay.classList.remove("flex");
      document.getElementById("nav-bar").style.transform = "translateY(100%)";

      showSuccessStep();

      setTimeout(function () {
        if (formState.jobId) {
          window.location.href = "/en/processing?jobId=" + encodeURIComponent(formState.jobId);
        } else {
          window.location.href = "/en/processing";
        }
      }, 800);
    }, 1000);

  } catch (error) {
    console.error("Submission error", error);

    if (String(error.message) === "413") {
      alert("Images are too large (size limit exceeded). Please choose smaller photos.");
    } else {
      alert("An error occurred during sending. Please check your connection.");
    }

    loadingOverlay.classList.add("hidden");
    loadingOverlay.classList.remove("flex");
  } finally {
    isSubmitting = false;
    btnNext.disabled = false;
  }
}
    </script>
</body>
</html>
